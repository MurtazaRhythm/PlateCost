<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Insights</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f4f6fb;
      --card: #ffffff;
      --text: #1f2933;
      --muted: #5f6b7a;
      --primary: #2563eb;
      --primary-strong: #1d4ed8;
      --border: #e5e7eb;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }
    a { color: inherit; text-decoration: none; }
    .nav {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .nav-inner {
      max-width: 1080px;
      margin: 0 auto;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .brand {
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--primary);
    }
    .nav-links {
      display: flex;
      gap: 14px;
      font-weight: 500;
      color: var(--muted);
    }
    .nav-links a { padding: 8px 10px; border-radius: 8px; }
    .nav-links a:hover { background: #eef2ff; color: var(--primary); }
    .page {
      max-width: 1080px;
      margin: 0 auto;
      padding: 24px 20px 48px;
    }
    h1 { margin: 8px 0 4px; font-size: 28px; }
    .lead { color: var(--muted); margin-bottom: 16px; }
    .card {
      background: var(--card);
      padding: 16px;
      margin-top: 16px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    .controls { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
    select, button {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f8fafc;
      font-weight: 500;
      color: var(--text);
    }
    button {
      cursor: pointer;
      border: none;
      background: var(--primary);
      color: white;
      box-shadow: 0 6px 18px rgba(37, 99, 235, 0.25);
      transition: transform 0.05s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    button:hover { background: var(--primary-strong); box-shadow: 0 8px 24px rgba(37, 99, 235, 0.35); }
    button:active { transform: translateY(1px); }
    table { width: 100%; border-collapse: collapse; margin-top: 6px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
    th { cursor: pointer; user-select: none; color: var(--muted); font-weight: 600; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; background: #eef2ff; color: #3949ab; font-weight: 600; }
    .status { margin-top: 8px; color: var(--muted); }
    .error { color: #b00020; }
    @media (max-width: 700px) {
      .nav-inner { flex-direction: column; align-items: flex-start; }
      .nav-links { width: 100%; justify-content: flex-start; flex-wrap: wrap; }
      table, thead, tbody, th, td, tr { display: block; }
      th { background: #f8fafc; }
      td { border: none; border-bottom: 1px solid var(--border); }
    }
  </style>
</head>
<body>
  <header class="nav">
    <div class="nav-inner">
      <div class="brand">PlateCost</div>
      <div class="nav-links">
        <a href="./index.html">Uploads</a>
        <a href="./dashboard.html">Dashboard</a>
        <a href="./insights.html">Insights</a>
      </div>
    </div>
  </header>
  <div id="root"></div>
  <script type="text/babel">
    const { useEffect, useMemo, useState, useRef } = React;
    // Insights table that surfaces AI-generated sentences with filters and sorting.
    const DATA_URL = "/receipts_dataset_insights.json";
    const AUTO_REFRESH_MS = 30000;

    function dedupe(arr) {
      return Array.from(new Set(arr.filter(Boolean))).sort();
    }

    function sortData(data, sortBy, dir) {
      const fn = {
        week: (a, b) => (a.week || "").localeCompare(b.week || ""),
        category: (a, b) => (a.category || "").localeCompare(b.category || ""),
        type: (a, b) => (a.type || "").localeCompare(b.type || ""),
        ai_sentence: (a, b) => (a.ai_sentence || "").localeCompare(b.ai_sentence || "")
      }[sortBy] || (() => 0);
      const sorted = [...data].sort(fn);
      return dir === "desc" ? sorted.reverse() : sorted;
    }

    function App() {
      const [insights, setInsights] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState("");
      const [filters, setFilters] = useState({ week: "", category: "", type: "" });
      const [sortBy, setSortBy] = useState("week");
      const [sortDir, setSortDir] = useState("desc");
      const timerRef = useRef(null);

      const load = async () => {
        setLoading(true); setError("");
        try {
          const res = await fetch(DATA_URL, { cache: "no-cache" });
          if (!res.ok) throw new Error("fetch_failed");
          const json = await res.json();
          const data = Array.isArray(json.insights) ? json.insights : [];
          setInsights(data);
        } catch (e) {
          setError("Unable to load insights. Please ensure data is available.");
          setInsights([]);
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        load();
        timerRef.current = setInterval(load, AUTO_REFRESH_MS);
        return () => { if (timerRef.current) clearInterval(timerRef.current); };
      }, []);

      const weeks = useMemo(() => dedupe(insights.map(i => i.week)), [insights]);
      const categories = useMemo(() => dedupe(insights.map(i => i.category)), [insights]);
      const types = useMemo(() => dedupe(insights.map(i => i.type)), [insights]);

      const filtered = useMemo(() => {
        let rows = insights;
        if (filters.week) rows = rows.filter(i => i.week === filters.week);
        if (filters.category) rows = rows.filter(i => i.category === filters.category);
        if (filters.type) rows = rows.filter(i => i.type === filters.type);
        return sortData(rows, sortBy, sortDir);
      }, [insights, filters, sortBy, sortDir]);

      const toggleSort = (col) => {
        if (sortBy === col) {
          setSortDir(sortDir === "asc" ? "desc" : "asc");
        } else {
          setSortBy(col);
          setSortDir(col === "week" ? "desc" : "asc");
        }
      };

      return (
        <div className="page">
          <h1>AI Insights</h1>
          <div className="lead">AI-written summaries of your spend insights with filters and sorting.</div>
          <div className="card">
            <div className="controls">
              <select value={filters.week} onChange={(e) => setFilters({ ...filters, week: e.target.value })}>
                <option value="">All Weeks</option>
                {weeks.map(w => <option key={w} value={w}>{w}</option>)}
              </select>
              <select value={filters.category} onChange={(e) => setFilters({ ...filters, category: e.target.value })}>
                <option value="">All Categories</option>
                {categories.map(c => <option key={c} value={c}>{c}</option>)}
              </select>
              <select value={filters.type} onChange={(e) => setFilters({ ...filters, type: e.target.value })}>
                <option value="">All Types</option>
                {types.map(t => <option key={t} value={t}>{t}</option>)}
              </select>
              <button onClick={() => setFilters({ week: "", category: "", type: "" })}>Reset</button>
              <button onClick={load}>Refresh</button>
            </div>

            {loading && <div className="status">Loading…</div>}
            {error && <div className="status error">{error}</div>}
            {!loading && !error && filtered.length === 0 && (
              <div className="status">No insights yet—upload receipts to generate insights.</div>
            )}

            {!loading && !error && filtered.length > 0 && (
              <table>
                <thead>
                  <tr>
                    <th onClick={() => toggleSort("week")}>Week {sortBy === "week" ? (sortDir === "asc" ? "▲" : "▼") : ""}</th>
                    <th onClick={() => toggleSort("type")}>Type {sortBy === "type" ? (sortDir === "asc" ? "▲" : "▼") : ""}</th>
                    <th onClick={() => toggleSort("category")}>Category {sortBy === "category" ? (sortDir === "asc" ? "▲" : "▼") : ""}</th>
                    <th onClick={() => toggleSort("ai_sentence")}>AI Sentence {sortBy === "ai_sentence" ? (sortDir === "asc" ? "▲" : "▼") : ""}</th>
                  </tr>
                </thead>
                <tbody>
                  {filtered.map((ins, idx) => (
                    <tr key={idx}>
                      <td>{ins.week || "—"}</td>
                      <td><span className="pill">{ins.type || "—"}</span></td>
                      <td>{ins.category || "—"}</td>
                      <td>{ins.ai_sentence || "—"}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
            <div className="status">Auto-refresh every 30s.</div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
