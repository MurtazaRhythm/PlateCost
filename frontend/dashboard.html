<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Receipt Spend by Category</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f4f6fb;
      --card: #ffffff;
      --text: #1f2933;
      --muted: #5f6b7a;
      --primary: #2563eb;
      --primary-strong: #1d4ed8;
      --border: #e5e7eb;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }
    a { color: inherit; text-decoration: none; }
    .nav {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .nav-inner {
      max-width: 1080px;
      margin: 0 auto;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .brand {
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--primary);
    }
    .nav-links {
      display: flex;
      gap: 14px;
      font-weight: 500;
      color: var(--muted);
    }
    .nav-links a { padding: 8px 10px; border-radius: 8px; }
    .nav-links a:hover { background: #eef2ff; color: var(--primary); }
    .page {
      max-width: 1080px;
      margin: 0 auto;
      padding: 24px 20px 48px;
    }
    h1 { margin: 8px 0 4px; font-size: 28px; }
    h2 { margin: 12px 0 8px; }
    .lead { color: var(--muted); margin-bottom: 16px; }
    .card {
      background: var(--card);
      padding: 16px;
      margin-top: 16px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    .small { color: var(--muted); font-size: 13px; }
    .status { margin-top: 12px; color: var(--muted); }
    canvas { max-width: 700px; width: 100%; margin-top: 10px; }
    .chart-combo {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chart-combo .charts {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: stretch;
    }
    .chart-combo .chart-pane {
      flex: 1 1 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .chart-combo.has-line .chart-pane {
      flex: 1 1 50%;
    }
    .chart-combo h3 { margin: 0 0 8px; }
    .chart-combo canvas {
      display: block;
      width: 100%;
      max-width: 720px;
      height: min(360px, 60vh);
      max-height: 70vh;
      margin: 0 auto;
    }
    @media (max-width: 700px) {
      .nav-inner { flex-direction: column; align-items: flex-start; }
      .nav-links { width: 100%; justify-content: flex-start; flex-wrap: wrap; }
      .chart-shell,
      .chart-shell.has-line {
        flex-direction: column;
      }
      .chart-shell .pie-card,
      .chart-shell.has-line .pie-card,
      .chart-shell .line-card,
      .chart-shell.has-line .line-card {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>
  <header class="nav">
    <div class="nav-inner">
      <div class="brand">PlateCost</div>
      <div class="nav-links">
        <a href="./index.html">Uploads</a>
        <a href="./dashboard.html">Dashboard</a>
        <a href="./insights.html">Insights</a>
      </div>
    </div>
  </header>
  <div id="root"></div>
  <script type="text/babel">
    const { useEffect, useState, useRef } = React;

    // Dashboard view for category spend summary and trends.
    // Prefer categorized data first (includes categories); fall back to raw OCR.
    const PREFERRED_URLS = [
      "/receipts_dataset_categorized.json",
      "/receipts_ocr.json"
    ];

    function parsePriceToFloat(val) {
      if (val === null || val === undefined) return 0;
      if (typeof val === "number") return val;
      if (typeof val !== "string") return 0;
      const cleaned = val.replace(/[$,]/g, "").trim();
      const num = parseFloat(cleaned);
      return isNaN(num) ? 0 : num;
    }

    function aggregateByCategory(data) {
      const totals = {};
      if (!Array.isArray(data)) return totals;
      data.forEach((receipt) => {
        (receipt.items || []).forEach((item) => {
          const cat = item.category || "Uncategorized";
          const amt = item.price_float !== undefined ? item.price_float : parsePriceToFloat(item.price);
          totals[cat] = (totals[cat] || 0) + (amt || 0);
        });
      });
      return totals;
    }

    async function fetchFirstAvailable(urls) {
      for (const url of urls) {
        try {
          const res = await fetch(url, { cache: "no-cache" });
          if (!res.ok) continue;
          const json = await res.json();
          // receipts_ocr.json is likely an array; receipts_dataset_categorized.json is likely an array or object
          if (Array.isArray(json)) return json;
          if (json && Array.isArray(json.receipts)) return json.receipts;
        } catch (e) {
          // try next
        }
      }
      throw new Error("No data available");
    }

    function ChartCard() {
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState("");
      const [totals, setTotals] = useState({});
      const [rawData, setRawData] = useState([]);
      const [selectedCategory, setSelectedCategory] = useState(null);
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      const loadData = async () => {
        try {
          const data = await fetchFirstAvailable(PREFERRED_URLS);
          setRawData(Array.isArray(data) ? data : []);
          const agg = aggregateByCategory(data);
          setTotals(agg);
          setError("");
        } catch (err) {
          setError("Unable to load data. Please ensure the backend JSON is served.");
        } finally {
          setLoading(false);
        }
      };

      const parsePriceToFloatSafe = (val) => {
        if (val === null || val === undefined) return 0;
        if (typeof val === "number") return val;
        if (typeof val !== "string") return 0;
        const cleaned = val.replace(/[$,]/g, "").trim();
        const num = parseFloat(cleaned);
        return isNaN(num) ? 0 : num;
      };

      const isoWeekKey = (dateStr) => {
        if (!dateStr) return null;
        const parts = dateStr.split(/[/-]/);
        if (parts.length !== 3) return null;
        const [m, d, y] = parts.map((p) => parseInt(p, 10));
        if (isNaN(m) || isNaN(d) || isNaN(y)) return null;
        const dt = new Date(y, m - 1, d);
        if (isNaN(dt.getTime())) return null;
        const tmp = new Date(Date.UTC(dt.getFullYear(), dt.getMonth(), dt.getDate()));
        // ISO week calculation
        const dayNum = tmp.getUTCDay() || 7;
        tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(), 0, 1));
        const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
        return `${tmp.getUTCFullYear()}-W${String(weekNo).padStart(2, "0")}`;
      };

      const computeWeeklyForCategory = (cat, receipts) => {
        if (!cat || !Array.isArray(receipts)) return [];
        const bucket = {};
        receipts.forEach((rec) => {
          const wk = isoWeekKey(rec.date);
          if (!wk) return;
          (rec.items || []).forEach((item) => {
            if (item.category === cat) {
              const amt = item.price_float !== undefined ? item.price_float : parsePriceToFloatSafe(item.price);
              bucket[wk] = (bucket[wk] || 0) + (amt || 0);
            }
          });
        });
        const entries = Object.entries(bucket)
          .map(([week, value]) => ({ week, value }))
          .sort((a, b) => (a.week > b.week ? 1 : -1));
        return entries;
      };

      useEffect(() => {
        loadData(); // one-time load on page view
      }, []);

      useEffect(() => {
        if (!canvasRef.current) return;
        if (chartRef.current) {
          chartRef.current.destroy();
          chartRef.current = null;
        }
        const entries = Object.entries(totals);
        if (entries.length === 0) return;
        const labels = entries.map(([k]) => k);
        const values = entries.map(([, v]) => v);
        const colors = labels.map((_, i) => `hsl(${(i * 65) % 360},70%,60%)`);
        chartRef.current = new Chart(canvasRef.current, {
          type: "pie",
          data: {
            labels,
            datasets: [{
              data: values.map((v) => Math.round(v * 100) / 100),
              backgroundColor: colors,
            }]
          },
          options: {
            onClick: (_evt, elems) => {
              if (!elems.length) return;
              const idx = elems[0].index;
              const cat = labels[idx];
              setSelectedCategory((prev) => (prev === cat ? null : cat));
            },
            plugins: {
              legend: { position: "bottom" },
            }
          }
        });
      }, [totals]);

      const weeklyData = selectedCategory ? computeWeeklyForCategory(selectedCategory, rawData) : [];

      return (
        <div className={`card chart-combo ${selectedCategory ? "has-line" : ""}`}>
          <h2>Spend by Category</h2>
          <div className="small">Data source: receipts OCR/categorized output</div>
          {loading && <div className="status">Loading...</div>}
          {error && <div className="status" style={{ color: "#b00020" }}>{error}</div>}
          {!loading && !error && Object.keys(totals).length === 0 && (
            <div className="status">No data available.</div>
          )}
          <div className="charts">
            <div className="chart-pane">
              {!loading && !error && Object.keys(totals).length > 0 && (
                <canvas ref={canvasRef} aria-label="Spend by Category"></canvas>
              )}
            </div>
            {selectedCategory && (
              <div className="chart-pane">
                <h3>{selectedCategory} Trend</h3>
                <LineChart category={selectedCategory} weekly={weeklyData} />
              </div>
            )}
          </div>
        </div>
      );
    }

    function LineChart({ category, weekly }) {
      const canvasRef = React.useRef(null);
      const chartRef = React.useRef(null);

      React.useEffect(() => {
        if (!category || !weekly || weekly.length === 0) {
          if (chartRef.current) {
            chartRef.current.destroy();
            chartRef.current = null;
          }
          return;
        }
        const ctx = canvasRef.current;
        if (!ctx) return;
        if (chartRef.current) {
          chartRef.current.destroy();
          chartRef.current = null;
        }
        const labels = weekly.map((w) => w.week);
        const data = weekly.map((w) => w.value);
        chartRef.current = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: `${category} spend`,
              data,
              borderColor: "rgba(75, 192, 192, 1)",
              backgroundColor: "rgba(75, 192, 192, 0.2)",
              tension: 0.3,
              fill: false,
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: {
              x: { title: { display: true, text: "Week" } },
              y: { title: { display: true, text: "Money spent" } },
            }
          }
        });
        return () => {
          if (chartRef.current) chartRef.current.destroy();
        };
      }, [category, weekly]);

      if (!category) return null;
      return <canvas ref={canvasRef} aria-label="Category Trend"></canvas>;
    }

    function App() {
      return (
        <div className="page">
          <ChartCard />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
